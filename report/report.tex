%
% report.tex - tex model of graduation work
% Version 0.1
%
% Author: Paulo S. Machado
% Date: 2S 2011
%
% Release under de GNU Public License v3.0 or greater
% This library is free software; you can redistribute it and/or
% modify it under the terms of the GNU General Public
% License as published by the Free Software Foundation; either
% version 3.0 of the License, or (at your option) any later version.
% 
% This template is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% General Public License for more details.
% 
% You should have received a copy of the GNU Lesser General Public
% License along with this template; if not, write to the Free Software
% Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
%
\documentclass[a4paper,11pt]{article}

\input{preamble.tex}

\parindent 1cm

% \parskip 5pt

\begin{document}

% Title page and table of contents
\input{title/title.tex}

\lstset{frame=single,
    showstringspaces=false,
    extendedchars=true,
    language=C++,
    backgroundcolor=\color[rgb]{0.95,0.95,0.95},
    rulecolor=\color[rgb]{0.3,0.3,0.3},
    basicstyle=\scriptsize\ttfamily,
    commentstyle=\color[RGB]{105,105,105}\rmfamily\itshape,
    keywordstyle=\color[rgb]{0.6,0.0,0.0}\bfseries,
    stringstyle=\color[rgb]{0.6,0.4,0.4},
    identifierstyle=\color[rgb]{0.0,0.0,0.5},
    basicstyle=\tiny,
    numbers=left,
}

%%%
%
\section{Resumo}
\label{sec:resumo}
Um trabalho de graduação em Engenharia de Controle e Automação deve,
idealmente, abranger as três grandes áreas que originam essa
formação\cite{enciclo}: Engenharia Elétrica (eletrônica, processamento de
sinais, circuitos elétricos e teoria de controle, etc); Engenharia
Mecânica (dinâmica, modelagem de sistemas, etc); e a Computação (automação,
controle discreto, etc). Este trabalho tenta, modestamente, resvalar por cada
uma destas áreas e honrar a formação recebida.

A ideia deste projeto surgiu das observações diárias de ciclistas e do
uso da bicicleta, onde grande parte das pessoas não sabe utilizar de
forma eficiente as marchas de suas bicicletas. Estas parecem ser
complicadas (\textit{mountain bikes} simples possuem pelo menos 18 marchas) e de
difícil manejo e configuração. Assim como em uma transmissão automotiva, maus
hábitos no seu manejo -- esticar marchas, manter a mão apoiada sobre a alavanca,
entre outros -- causam desgaste precoce dos componentes, esforços desnecessários
(neste caso para ciclista) e até risco de segurança.

O benefício primordial de qualquer automação (i.e. retirar do usuário o
controle ou parte do controle sobre o sistema que interage) é a melhora no
fluxo do processo devido ao grande controle que tem se sobre o sistema. Os
resultados deste benefício são, em alto nível, o aumento da qualidade,
repetibilidade e uniformidade, aplicação de estratégias ótimas de controle e
simplicidade na interação com utilizador.

Este relatório apresenta o desenvolvimento e resultados do trabalho proposto e
estudado na primeira disciplina de Trabalho de Graduação: a construção de um
protótipo funcional de um sistema de troca de marchas automatizados para
bicicletas convencionais. Neste primeiro trabalho foram construídas as base
teóricas e ferramentais para a construção de um protótipo funcional: construção
da bancada experimental; desenvolvimento da lógica; e estudo de soluções 
existentes. Ou seja, dados os objetivos do projeto -- software de controle,
circuito de controle, atuados mecânico e a junção destes no protótipo --
apresenta-se o caminho percorrido até o objetivo e os resultados alcançados.

O documento foi estruturado de forma a descrever o problema de engenharia, as
alternativas consideradas, escolhas e desenvolvimento de cada parte funcional do
protótipo final.


\pagebreak
%%%
%
\section{Introdução}
\label{sec:intro}
Automação ou Controle? Esta foi a tônica no início do desenvolvimento
deste projeto. A solução de controle é mais elegante, porém seu desenvolvimento
é mais complexo e depende de um sinal contínuo. A automação não é tão elegante e
eficiente, porém seu desenvolvimento é mais simples e pode ser orientada a
eventos. A resposta, seja ela qual for, passa obrigatoriamente pela análise do
problema físico.

\subsection{Análise do problema físico}
A transmissão ciclística é tal qual mostrado na figura \ref{fig:transmissao}.
\begin{figure}[ht]
\begin{center}
 \includegraphics[width=5.5in]{transmissao}
\end{center}
  \caption{Componentes de uma transmissão ciclística}
  \label{fig:transmissao}
\end{figure}
Podemos observar os principais componentes da transmissão, sendo na ordem em que
a energia é transmitida: o pedivela transmite o torque aplicado aos pedais pelo
ciclista às coroas dianteiras, que movimentam a corrente, que por sua vez,
transmite a energia às coroas traseiras (o conjunto destas é chamado de cassete,
nome que será usado no documento), conectadas a roda traseira, gerando a
movimento.

A relação de transmissão é determinada pela quantidade de dentes da coroa
traseira e dianteira de um engrenamento. Assim, a troca de marcha
(i.e. da relação de transmissão) é realizada pela mudança no engrenamento da
corrente com as coroas, tanto dianteiras  quanto traseiras. Portanto uma
bicicleta possui tantas marchas quanto forem a multiplicação da quantidade de
coroas no cassete pelas coroas dianteiras, por exemplo, quando há três coroas
dianteiras e seis coroas no cassete, a transmissão possui 3x6=18 marchas.
A mudança no engrenamento é realizado pelos
\textit{derailleurs}\footnote{\textit{Derailleur} é um termo francês que pode
ser traduzido como o ato do descarrilamento de um trem na ferrovia. O
dispositivo ganhou esse nome devido à semelhança com o evento.}, que mediante ao
deslocamento longitudinal ao eixo da roda força a corrente ser engrenada em
outra coroa.

O desenvolvimento do protótipo é tratado como uma prova de conceito, e por
simplicidade, a atuação vai ser concentrada nos componentes da parte traseira
da transmissão, ou seja, no \textit{derailleur}.
O esquema da figura \ref{fig:derailleur} apresenta a visão traseira
do \textit{derailleur} traseiro e três exemplos de engrenamento.
\begin{figure}[ht]
\begin{center}
 \includegraphics[width=4in]{derailleur}
\end{center}
  \caption{Visão traseira de engrenamentos de um \textit{derailleur}.}
  \label{fig:derailleur}
\end{figure}
Na figura \ref{fig:derailleur} temos, respectivamente, engrenado uma marcha
lenta (alto torque e baixa velocidade), uma marcha média e uma marcha rápida
(baixo torque e alta velocidade). O movimento da gaiola (componente do
\textit{derailleur}) se dá pela sua estrutura de braços paralelos do
\textit{derailleur} e é acionado via cabo, com retorno por mola. O cabo é
controlado pelo ciclista, geralmente por um sistema alavanca montado no guidão,
mas que também assume diversas outras formas, sempre com o objetivo de puxar ou
soltar o cabo, e genericamente chamado trocador (\textit{shifter}). O
trocador movimenta o cabo em estágios discretos, sendo cada estágio desse
correspondente ao engrenamento em uma coroa diferente.

O ciclista controla a pedalada de acordo com seu gosto, terreno e
velocidade. Logo, quando está em um aclive, procura puxar o cabo de forma a
engrenar as marchas mais lentas, e o oposto quando enfrenta um declive ou um
terreno que ofereça menos resistência, como por exemplo asfalto plano. O gosto e
biótipo do ciclista determinam o ponto da troca de marcha pela velocidade da
cadência (velocidade da pedalada). Por exemplo, o sete vezes campeão do
\textit{Tour de France}, Lance Armstrong, prefere pedalar em alta velocidade
(picos de 100-110 RPM), enquanto que outros ciclistas de sua categoria
dificilmente alcançam 90 RPM de
cadência\footnote{
www.trifuel.com/training/bike/cycling-cadence-and-pedaling-economy}.
Ciclistas amadores possuem limites bem inferiores. Portanto, uma premissa básica
do projeto é a possibilidade do ajuste sobre os limites para a troca de marcha.

O resultado da análise do problema físico levou a escolha pela solução de
automação, preterindo o controle. A decisão baseou-se na observação de que o
sistema de uma transmissão de bicicleta, considerando as possíveis alternativas
para a forma de aquisição de dados de custo acessível, é orientado a
eventos e baseado em estados discretos.

\subsection{Revisão bibliográfica}
Uma ampla revisão bibliográfica foi realizada na primeira parte deste Trabalho
de Graduação, e não será repetida neste relatório. Vale ressaltar porém, que
pouca bibliografia acadêmica é produzida sobre o assunto. Por outro lado, o
desenvolvimento comercial é bastante prolífico, havendo em torno de quatro ou
cinco companhias multinacionais liderando os mercados globais de componentes e
diversos garagistas pensando e desenvolvendo soluções.

O problema que surge é como localizar documentação sobre uma solução tão
específica? A resposta foi a utilização de duas bases de patentes:
USPTO\cite{uspto} e EPO\cite{epo}. O critério de escolha utilizado para
selecionar apenas os dois escritórios foi o fato de constituírem os dois maiores
mercados consumidores do mundo.


\subsection{Premissas do projeto}
Após o estabelecimento do tipo de solução e de alguns requisitos mínimos, as
premissas estabelecidas para o projeto são:
\begin{itemize*}
  \item Baixo custo
  \item Adaptabilidade ao sistema existente
  \item Possibilidade de configuração de parâmetros
  \item Interface com usuário
\end{itemize*}



\pagebreak
%%%
%
\section{Desenvolvimento das partes}
\label{sec:partes}
Nesta seção são apresentadas as partes do projeto e como estas foram unidas. O
desenvolvimento deste projeto foi modular, o que permitiu na maior parte do
tempo trabalhar no hardware e no software de forma independente. As partes são:
\begin{itemize*}
  \item Bancada experimental
  \item Circuito de controle
  \item Protótipo Completo
  \item Algoritmo de Controle
\end{itemize*}


\subsection{Bancada experimental}
\label{sec:bancada}
A bancada experimental é um dos produtos principais da primeira parte deste
trabalho de graduação. Simular os sinais do sistema via algum tipo de software
ou kit é uma opção menos desejável, visto que o de desenvolvimento
do projeto com base em um sistema real não se apresentou como uma proposta
complicada ou muito cara. Desta forma, a solução elaborada no primeiro trabalho
foi usar uma bicicleta convencional e adaptá-la de forma a criar uma bancada de
testes. O resultado é apresentado na Figura
\ref{fig:bancada}.
\begin{figure}[ht]
 \begin{center}
  \includegraphics[width=3.5in]{bancada_tratada}
 \end{center}
 \caption{Bancada experimental construída para o TG I}
 \label{fig:bancada}
\end{figure}
A bancada é uma meia bicicleta -- com a parte traseira, onde estão os
elementos da transmissão  -- onde foram soldados apoios, possibilitando
``pedalar no vazio'' e realizar os testes do projeto em um sistema real.

Foram diversos os problemas relativos a bancada, e surgiram no momento prévio
aos testes, quando os componentes da transmissão foram montados. As peças
disponíveis não eram compatíveis (corrente curta, coroa dianteira
não casou com o corrente), o que causou novos custos e atraso nos testes.
Superados os percalços, o resultado final é apresentado na figura
\ref{fig:setup}. Nesta montagem estão presentes, além do sistema mecânico
completo da bicicleta, a montagem do servo motor e os ímas acoplados ao
pedivela e a roda.
\begin{figure}[h!]
\begin{center}
 \includegraphics[width=5in]{setup}
\end{center}
  \caption{Bancada pronta para teste}
  \label{fig:setup}
\end{figure}


%%%
%
\subsection{Circuito de controle}
\label{sec:montagem}
O circuito de controle foi montado sobre uma placa de prototipação (protoboard)
e seu esquema geral é apresentado na figura \ref{fig:montagem}.
Os componentes podem ser separados em três grupos funcionais: saídas, controle
e entradas.
\begin{figure}[ht]
\begin{center}
 \includegraphics[width=3.2in]{montagem}
\end{center}
  \caption{Componentes da montagem do circuito de controle}
  \label{fig:montagem}
\end{figure}
Nessa classificação são: saídas, servo motor e LCD (\textit{Liquid
Crystal Display}; controle, MCU (\textit{MicroControler Unit}); e entradas os
\textit{push buttons} e \textit{reed switch}. Os componentes utilizados e
detalhes da integração são descritos a seguir.

\subsubsection{Servo Motor}
\label{sec:servo}
O servo motor é o único atuador deste projeto, sendo responsável pela atuação
sobre o cabo do \textit{derailleur} e consequente troca de marchas. Duas
perguntas foram elaboradas para ajudar na definição de um atuador: Qual a
forma mais simples de atuar sobre um cabo utilizando um motor rotativo? Qual
tipo de motor é confiável de controle simples? A reposta, encontrada a partir
do estudo realizado na primeira parte do trabalho de graduação é, uma polia
acoplada a um servo motor.

O raio da polia foi dimensionado de tal forma que, dado que um servo motor
rotaciona 180\textdegree, meia circunferência da polia seja deslocamento
suficiente para movimentar o \textit{derailleur} da menor a maior marcha.
Assim, definimos o raio da polia ($r_{polia}$), o número de marchas (n) e o
passo (p) como o deslocamento necessário do cabo de comando para a mudança de
uma marcha consecutiva, de tal forma que:
\begin{equation*}
  \frac{\displaystyle 2\pi r_{polia} }{\displaystyle 2} = (n-1)p
\end{equation*}
\begin{equation}
  r_{polia} = \frac{\displaystyle (n-1)p}{\displaystyle \pi}
\end{equation}
Para a bancada de testes, n=6 e p=3 mm. O raio ideal para a polia é:
\begin{equation}
 r_{polia} = \frac{\displaystyle (6-1)\times 3}{\displaystyle \pi} = 4.77~mm
\end{equation}
Porém, este resultado não foi utilizado, pois a construção de uma polia foi
preterida pela adaptação de um trocador manual (figura \ref{fig:shifter}).
\begin{figure}[h!]
\begin{center}
 \includegraphics[width=4in]{shifter}
\end{center}
  \caption{Trocador manual antes da adaptação}
  \label{fig:shifter}
\end{figure}

A polia interna deste trocador possui raio de 8.5 mm, o que por um lado aumenta
o intervalo de marchas disponível e a velocidade da troca, por outro aumenta o
requisito de torque no eixo. A figura \ref{fig:atuador} mostram a sequência da
adaptação.
\begin{figure}[h!]
 \centering
  \subfloat[Partes]{\includegraphics[width=1.9in]{polia1}} \hfil
  \subfloat[Partes Montadas]{\includegraphics[width=1.87in]{polia2}} \hfil
  \subfloat[Atuador Completo]{\includegraphics[width=1.9in]{polia3}}
  \caption{Sequência de adaptação do atuador}
  \label{fig:atuador}
\end{figure}

Pequenos servos RC (motores destinados ao mercado de hobbistas) são baratos,
fáceis de encontrar, robustos e seu controle é feito por um sinal PWM. O
servo motor escolhido foi um Futaba S3004, visto na figura \ref{fig:
servo}. O S3004 possui rolamentos de esferas no eixo de saída, e torque de
4.1kg-cm a 6 volts, o que no SI equivale a $4.1 \times 9.81 \times 10^{-2} =
0.4022$ Nm.

\begin{figure}[ht]
 \begin{center}
  \includegraphics[width=3.2in]{S3004}
 \end{center}
 \caption{Servo Futaba S3004}
 \label{fig: servo}
\end{figure}

Dois complicadores existem na utilização de servos motores\cite{servo}, em
relação a seu comportamento elétrico. O primeiro, como todo componente indutivo,
são os picos de corrente a cada mudança de posição, que podem drenar toda
corrente destinada ao controlador. O segundo complicador é o ruído, tanto gerado
pelo servo nas escovas do motor DC, quanto captado pelo cabo de sinal -- é comum
ver um servo "tremendo" quando em repouso, pois o cabo do sinal atua como uma
antena. Para mitigar estes efeitos a alimentação do servo foi isolada da
alimentação do resto do protótipo. O único cuidado adicional é manter as
referências no mesmo potencial, ou seja, manter o terra dos dois circuitos no
mesmo potencial.

\subsubsection{Display LCD 16x2}
\label{sec:lcd}

Como o sistema propõe uma interface com o usuário, um display LCD foi escolhido
para executar este papel. A principal vantagem deste tipo de display é o baixo
consumo de energia, essencial em sistemas embarcados, devido a independência de
uma fonte de luz própria. O tamanho de 16 caracteres e duas linhas é suficiente
para mostrar as informações de velocidade imediata, a marcha engatada e o valor
da constante de ajuste, planejadas para esta interface.

O display utilizado é um JHD-162a\cite{lcd} de fabricante desconhecido e
facilmente encontrado no mercado, visto na figura \ref{fig:lcd}.
\begin{figure}[ht]
\begin{center}
 \includegraphics[width=3in]{jhd162a2}
\end{center}
  \caption{Display LCD 16x2}
  \label{fig:lcd}
\end{figure}

A montagem do display não ofereceu nenhum problema, funcionando \textit{out of
the box}, o que é creditado a fartura de boa documentação encontrada na
Internet.

\subsubsection{Reed Switch}
\label{sec:reed}

A definição e uso de elementos sensores foi um dos elementos chave deste
projeto. Estes deveriam ser usados para a leitura de pulsos a cada revolução da
roda e do pedivela, gerando as informações de velocidades, básica ao algoritmo
de controle. As soluções analisadas foram:
\begin{itemize}
 \item Sensor capacitivo
 \item Sensor indutivo
 \item \textit{Reed switch}
 \item Sensor de efeito HALL
\end{itemize}
Os principais critérios de escolha, que permearam o projeto desde sua concepção,
foram simplicidade e custo. O escolhido foi o  \textit{reed switch}, que
oferece uma enorme margem de vantagem nos critérios escolhidos, e já é a
implementação padrão de computadores ciclísticos.

Um \textit{reed switch} é uma chave normalmente aberta constituída de duas
lâminas ferromagnéticas flexíveis, que sob influência de um campo magnético,
fecha o contato. A figura \ref{fig:reed} apresenta o conceito é um
\textit{reed} como os utilizados.

\begin{figure}[h!]
 \centering
  \subfloat[Uma ampola \textit{reed} e
partes.]{\includegraphics[width=2.5in]{reed}} \hfil
  \subfloat[Contato fecha com
influência de campo magnético.]{\includegraphics[width=2.5in]{reedschema}}
  \caption{O \textit{Reed Switch}.}
  \label{fig:reed}
\end{figure}



Um problema grave dos \textit{reed switch} é o ruído gerado na
sua operação. Devido ao \textit{bouncing}\cite{reed} o sinal gerado precisa de
um tratamento para que possa ser lido corretamente. Foi considerado realizar o
\textit{debounce} do sinal de duas formas: via software; ou via hardware. A
primeira foi descartada pois as funções do programa responsáveis pelo
cálculo de velocidade seriam rotinas de interrupção, ou seja, eles devem ter uma
execução muito breve, caso contrário podem afetar a contagem de tempo do
sistema. Uma função de \textit{debounce} em software envolve, inerentemente
algum \textit{delay}.

\begin{figure}[ht]
 \begin{center}
  \includegraphics[width=2.8in]{lowpass}
 \end{center}
 \caption{Filtro passa-baixa passivo acoplado ao \textit{reed switch}}
 \label{fig:lowpass}
\end{figure}

A única saída foi mesmo implementar o \textit{debounce} em hardware, utilizando
um filtro passa-baixa passivo, que usa apenas um resistor e um capacitor, de
acordo com o esquema da Figura \ref{fig:lowpass}. O ruído de um \textit{reed
switch} comum está na faixa de 1500Hz a 2000Hz\cite{reed}. É possível estimar a
frequência máxima ($f_{max}$) de ativação dos \textit{reeds} a partir de um
limite de velocidade da roda ($v_{max} = 90 km/h = 25 m/s$):
\begin{equation}
  v = \omega r = 2\pi f r \Rightarrow v_{max} = 2\pi f_{max} r
\end{equation}
O diâmetro da roda com pneu foi medido em d=65cm = 0.65m. Portanto, para
velocidade máxima de 90 km/h:
\begin{equation}
  f_{max} = \frac{\displaystyle v_{max}}{\displaystyle \pi d} =
\frac{\displaystyle 25}{\displaystyle \pi 0.65} = 12.243 Hz
\end{equation}
Tomando a frequência de corte ($f_{c}$) dada pela relação,
\begin{equation}
  f_{c} = \frac{\displaystyle 1}{\displaystyle 2\pi\tau} \text{, onde } \tau =
RC
\end{equation}
igual a frequência máxima ($f_{max}$), diversas combinações de resistores e
capacitores são possíveis. Logo, o script \ref{code:filter} escrito em
linguagem pyhton\cite{python} foi usado para ajudar a dimensionar os
componentes, de acordo com o que foi adquirido (Sec. \ref{custos}) e o que foi
obtido.

\subsubsection{Push buttons}
\label{sec:buttons}
Os \textit{push buttons} têm a função de modificação da constante de ajuste do
sistema, incrementado ou decrementando seu valor. São elementos bastante
simples, que como os \textit{reed switch}, produzem ruído pelo fenômeno de
\textit{bouncing}. Porém como a sua aplicação não é crítica, não houve a
preocupação em tratar o sinal, pois o funcionamento do sistema praticamente não
é prejudicado por estas falhas.
\begin{figure}[ht]
\begin{center}
 \includegraphics[width=2.5in]{pulldown}
\end{center}
  \caption{Resistor \textit{pull-down}}
  \label{fig:pulldown}
\end{figure}

A única observação feita em relação a montagem dos \textit{push buttons} é a
topologia \textit{pull-down} do resistor, mostrado na figura \ref{fig:pulldown}.
Este dispositivo é usado para limitar a corrente que passa do $V_{cc}$ para o
terra, e para garantir que o nível lógico seja coerente quando a chave conectada
está inativa, ``puxando'' a corrente para o terra. Tipicamente utiliza-se valor
de resistência de 10k$\Omega$, o que foi respeitado na montagem.



\subsubsection{Microcontrolador (MCU)}
\label{sec:mcu}
O microcontrolador utilizado é um ATMega168 20PU do fabricante
Atmel\textsuperscript{\textregistered}. O ATMega168\cite{atmega} é um
microcontrolador de 8 bits com 16K bytes de memória de programa e clock de 20MHz
e arquitetura RISC. O ATMega168 possui diversos periféricos dentre os quais são
de interesse para o projeto:
\begin{itemize}
  \item 6 canais PWM
  \item 23 I/O programáveis (digitais e analógicos)
  \item Interrupção e \textit{wake-up} na borda de subida ou descida de sinal
  \item Interface serial para programação
\end{itemize}

A utilização direta do microcontrolador requer diversos cuidados em relação a
sua alimentação, configuração de pinagem e recursos. Qualquer desenvolvedor de
sistemas embarcados sabe que este tipo de cuidado toma grande quantidade de
tempo e pode ser fonte de infindáveis problemas. Como resolver problemas de
natureza eletrônica e configuração de bits não é o propósito deste trabalho,
foi feita a escolha por uma plataforma de prototipagem que resolve grande parte
deste problemas: o Arduino\cite{arduino}\cite{oxer2009practical}.

O Arduino é uma plataforma de prototipagem \textit{open-source} (hardware e
software) que utiliza microcontroladores Atmel Mega168, Mega328 e Mega1280. Além
dos recursos providos pelo microcontrolador, são embarcados conversor
USB/Serial, tornando desnecessária uma porta serial no PC de desenvolvimento,
\textit{bournes} para conexão dos pinos de I/O, botão de \textit{reset},
cristal oscilador externo e entrada de alimentação. O circuito é capaz
de selecionar automaticamente qual fonte de alimentação utilizar (USB ou fonte
externa).

O modelo de escolhido para este trabalho foi o \textit{Duemilanove}, que
utiliza o microcontrolador ATMega168, e pode ser visto na figura
\ref{fig:duemilanove}.
% FOTO Duemilenove
\begin{figure}[h]
\begin{center}
 \includegraphics[width=3in]{duemilanove}
\end{center}
  \caption{Arduino Duemilanove}
  \label{fig:duemilanove}
\end{figure}

A linguagem de programação utilizada é o C/C++, sendo que o compilador
utilizado foi o GNU Compiler Collection, o GCC\cite{gcc}. Uma das grandes
vantagem da utilização do GCC é ser multiplataforma, além do fato de ser
software livre. O Arduino provêm uma IDE e bibliotecas para o desenvolvimento
de aplicações, das quais foram utilizadas no projeto as bibliotecas
\textit{Servo} e \textit{LiquidCrystal}, responsáveis pela manipulação de servo
motores e display LCD, respectivamente.

%%%
%
\subsection{Protótipo}
\label{sec:prototipo}
O circuito completo do projeto, conforme esquematizado na figura
\ref{fig:montagem} é apresentado na figura \ref{fig:circuito}.
\begin{figure}[h]
\begin{center}
 \includegraphics[width=4.5in]{circ_detail}
\end{center}
  \caption{Circuito completo do Projeto}
  \label{fig:circuito}
\end{figure}
O único componente adicional é o potenciômetro, usado para regular o contraste
do display LCD. Destaca-se na metade superior direita os circuitos para
tratamento das entradas (dois filtros passa-baixa e duas montagens de resistor
\textit{pull-down}).

%%%
%
%\pagebreak

\subsection{Algoritmo de controle}
\label{sec:software}
A lógica do programa, elaborada ainda na primeira parte deste trabalho e que se
manteve fiel ao design original é apresentada na figura \ref{fig:fluxograma1} e
descrita a seguir.

\begin{figure}[hb!]
 \begin{center}
  \includegraphics[width=4.65in]{fluxograma1}
 \end{center}
 \caption{Lógica do programa de automação da transmissão}
 \label{fig:fluxograma1}
\end{figure}

\begin{description*}
  \item[Inicio:] início do programa.
  \item[Pedalando:] recebe informação da cadência e se nula, significa que o
  ciclista não está pedalando. Nesse caso, o sistema passa para o teste de
  bateria  e atualização do display. Caso contrário, segue para o passo
  seguinte, de  leitura de velocidade.
  \item[Leitura de velocidade:] armazena a leitura de velocidade instantânea do
  sensor de velocidade da roda traseira.
  \item[Calcula limites:] a partir de uma tabela de limites padrão e do valor da
  constante de velocidade (variável que armazena o valor do multiplicador dos
  limites, para adequação ao estilo de pedalada do ciclista), é calculado o
  limite de velocidade inferior e superior para a marcha presente.
  \item[Velocidade além do limite superior para a relação:] compara leitura de
  velocidade da roda traseira com o calculo do limite superior de velocidade
  para a marcha.
  \item[Velocidade abaixo do limite inferior para a relação:] compara leitura de
  velocidade da roda traseira com o calculo do limite inferior de velocidade
  para a marcha.
  \item[Próxima coroa disponível:] checa se a coroa atual engrenada é a última
  (coroa
  com menos dentes, ou seja, de maior velocidade).
  \item[Coroa anterior disponível:] checa se a coroa atual engrenada é a
  primeira (coroa com mais dentes, ou seja, de maior torque).
  \item[Movimenta \textit{derailleur} para próxima coroa:] caso a velocidade
  seja  maior que o limite superior da coroa atual e exista a próxima coroa, o
  \textit{derailleur}  é movimentado para engatar a coroa seguinte.
  \item[Movimenta \textit{derailleur} para coroa anterior:] caso a velocidade
  seja  menor que o limite inferior da coroa atual e exista a coroa anterior, o
  \textit{derailleur}  é movimentado para engatar a coroa anterior.
  \item[Checa bateria:] testa a carga da bateria e armazena informação. Esta é
  uma etapa muito importante em qualquer dispositivo embarcado, pois é da
  bateria que vem a energia necessária ao funcionamento do sistema.
  \item[Atualiza display:] atualização da interface com informação de velocidade
  instantânea, marcha engatada, e carga da bateria.
\end{description*}

\subsubsection{Estrutura do Código}
\label{sec:implemt}

A estrutura do código, dividido entre uma biblioteca onde foram modeladas
classes para a representação do \textit{derailleur} e da roda de bicicleta. Esta
opção se pauta em dois princípios, um técnico e outro filosófico,
respectivamente: utilizar a característica de representação do mundo físico
oferecida pelo programação orientada a objetos; a posterior redistribuição do
código como software livre\footnote{Todo código fonte deste trabalho, inclusive
este relatório, está disponível no site de hospedagem de código github
(\url{https://github.com/paulomach/TG-II}) sob a licença GPL v3\cite{gpl}.},
visando a expansão e melhoria do projeto.

Fisicamente, os arquivos estão organizados:

\begin{verbatim}
BikeTransmission/
|-- BikeTransmission.cpp
|-- BikeTransmission.h
`-- keywords.txt
principal/
`-- principal.pde
\end{verbatim}

Os arquivos $BikeTransmission$ são a interface e implementação da biblioteca
que modela os elementos físicos do projeto. O arquivo $keywords.txt$ é o arquivo
de configuração para o destaque das palavras chaves introduzidas pela biblioteca
na IDE do Arduino. O arquivo $principal.pde$ é o programa principal onde a
biblioteca do projeto é usada.

A biblioteca \textit{BikeTransmission} modela basicamente duas classes que
representam a roda e o \textit{derailleur}. Um diagrama UML das classes está na
figura \ref{fig:uml} a seguir.

\begin{figure}[h!]
\begin{center}
  \includegraphics[width=4in]{uml}
\end{center}
  \caption{Representação UML da biblioteca \textit{BikeTransmission}}
  \label{fig:uml}
\end{figure}

A roda traseira ($RearWheel$) possui um atributo representando o diâmetro da
roda, e um método para calcular a velocidade linear, além do método construtor.
O \textit{derailleur} possui dois métodos, um para obter a marcha engatada
($get\_gear$), e outro para selecionar uma nova marcha ($set\_gear$). Utiliza o
construtor padrão, pois não há configurações especiais.

O código integral está nos Anexos, nas seções \ref{code:api}, \ref{code:impl} e
\ref{code:main}, que são respectivamente, API (\textit{Application Programming
Interface}), a implementação da API e o código do programa principal que
utiliza a API. Os detalhes da implementação estão descritos na seção
\ref{sec:resultados} Testes e Resultados e especialmente na seção
\ref{sec:code_detail}, pois o desenvolvimento do código foi indissociável dos
testes.

\pagebreak
%%%
%
\section{Testes e Resultados}
\label{sec:resultados}

\subsection{Teste Preliminar}

Para início dos testes, antes de finalizada a bancada, um esquema de testes
físicos auxiliar era necessário. O objetivo é de alguma forma obter os sinais
que seriam obtidos pelo sistema real, ou seja, gerar os acionamentos dos
\textit{reed switch's} com as frequências esperadas para o sistema real.

Para satisfazer esse requisito de teste, uma plataforma foi desenvolvida
utilizando baterias, pequenos motores DC, potenciômetros (para regulação da
tensão nos motores, e logo sua velocidade), algumas peças de
LEGO\textsuperscript{\textregistered} para a montagem, e um par de ímãs
acoplados para o acionamento dos \textit{reed's}. A plataforma finalizada pode
ser vista em ação na figura \ref{fig:test1}.

\begin{figure}[h!]
\begin{center}
 \includegraphics[width=5.5in]{test1}
\end{center}
  \caption{Plataforma de testes}
  \label{fig:test1}
\end{figure}

Na parte de trás, o par trançado vermelho e preto é o cabeamento de um
\textit{reed}, enquanto que o \textit{protoboard} branco no centro à esquerda é
o circuito de controle da velocidade do motor DC. Acoplado a polia de trás há
um pequeno ímã de neodímio (também conhecido como ímã de terras raras),
extraído de um disco rígido. Este é um ímã poderoso considerando seu tamanho, e
gera o campo magnético necessário a ativação do \textit{reed} a até
aproximadamente 5 mm de distância.

Essa montagem permitiu a geração de um sinal em uma das duas entradas do
sistema, sendo que a segunda entrada foi gerada manualmente com outro ímã de
neodímio. Gerar o sinal manualmente se mostrou mais conveniente, pois a mudança
da frequência de entrada fica mais fácil de manipular, visto que o
potenciômetro disponível se apresentou pouco amigável, se comportando mais como
um interruptor do que como uma resistência variável.

\subsubsection{Debugando o código}
%TODO inserir detalhes do código numeração de linhas

Para visualizar o funcionamento e \textit{debug} do código, apenas observar a
saída do sistema (movimentação do servo motor) não é suficiente. A primeira
medida é a configuração do display LCD, mapeado como na figura
\ref{fig:schemalcd}, contendo as informações mais básicas para a verificação do
sistema. A numeração na figura é referente a posição de cada caractere do
display. Um exemplo do mapeamento já foi dado na figura \ref{fig:lcd}.

\begin{figure}[h!]
\begin{center}
  \includegraphics[width=5.5in]{lcd}
\end{center}
  \caption{Esquema de configuração do display LCD}
  \label{fig:schemalcd}
\end{figure}

Este mapeamento é necessário para a codificação do display, apresentado no
trecho do código a seguir.
\begin{lstlisting}
  ...
  // LCD initialization
  LiquidCrystal lcd ( 7, 6, 5, 4, 8, 10 );
  ...
  // LCD static setup
  lcd.begin ( 16,2 );
  lcd.print( "start up..." );
  delay(2000);
  lcd.clear();
  lcd.print ( "Vel:" );
  lcd.setCursor ( 8,0 );
  lcd.print ( "kmph" );
  lcd.setCursor ( 0,1 );
  lcd.print ( "Marcha:" );
  lcd.setCursor ( 10,1 );
  lcd.print ( "K:" );
  ...
  // Update LCD
  void update_lcd() {
    lcd.setCursor ( 4,0 );
    lcd.print("    ");
    lcd.setCursor ( 4,0 );
    lcd.print ( wspeed );
    lcd.setCursor ( 7,1 );
    lcd.print ( gear );
    lcd.setCursor ( 12,1 );
    lcd.print ( K );
  }
...
\end{lstlisting}

Ainda assim, para o \textit{debug} do sistema mais informação é necessária. A
opção é a utilização dos recursos de comunicação serial do Arduino, que pode
transmitir dados em formato texto pela mesma porta USB usada para carregar e
alimentar o sistema. Para configurar e usar esta comunicação, o código:

\begin{lstlisting}
...
// Config Serial baud rate
Serial.begin ( 9600 );
...
/*
 * Serial debug output routine
 */
void update_serial() {
  if (debugLevel == 2) {
    Serial.print ( "Velocidade: " );    Serial.print ( wspeed );
    Serial.println(" kmph");
    Serial.print ( "Marcha: " );        Serial.println ( gear );
    Serial.print ( "Tempo roda: " );    Serial.print ( wtime );
    Serial.println (" ms" );
    Serial.print ( "Tempo cadencia: " );Serial.print ( ctime );
    Serial.println (" ms" );
    Serial.print ("K: ");               Serial.println (K);
    Serial.println("");
  }
}
...
\end{lstlisting}

Em qualquer parte do código pode ser adicionado um comando de impressão serial,
contendo o valor de uma variável, uma informação textual ou ambos. Um exemplo
dos das informações normalmente impressas na saída serial está na figura
\ref{fig:serial}.

\begin{figure}[h!]
\begin{center}
 \includegraphics[width=3in]{serial}
\end{center}
  \caption{Saída serial com informação de \textit{debug}.}
  \label{fig:serial}
\end{figure}





\subsubsection{Resultados}

Esta montagem preliminar foi útil especialmente para a calibração das entradas
realizando teste do \textit{debounce} dos \textit{reed switch} e botões,
redimensionando quando necessários os capacitores e resistores da montagem. A
geração manual de um sinal mostrou-se inapropriada, então logo que possível,
foi feita a montagem na bancada para testes reais.

\subsection{Teste de Bancada}

A bancada da figura \ref{fig:setup} foi testada e após o primeiro
\textit{startup}, os sinais de entrada foram adquiridos corretamente, e os
sinais de saída apresentados no display e no monitor serial estavam coerentes.
Porém um detalhe do mais importante falhou: mesmo com uma nova marcha engatada,
nenhum movimento foi observado no \textit{derailleur}.

A conclusão é que o servo motor usado simplesmente não possui torque suficiente
para enrolar o cabo que movimenta o \textit{derailleur}, o que é discutido a
seguir.

São duas fontes de resistência a este movimento, sendo a primeira o atrito do
cabo no conduíte, e a segunda e principal, a mola de retorno do
\textit{derailleur}. Três alternativas para contornar este problema foram
estudadas, sendo:
\begin{enumerate*}
  \item Diminuir o raio da polia, minimizando o torque necessário no eixo do
servo motor.
  \item Redimensionar a mola de retorno do \textit{derailleur} para um valor
menor da constante elástica.
  \item Redimensionar o servo motor, ou seja, utilizar um que forneça maior
valor de torque.
\end{enumerate*}

A primeira alternativa esbarrou em uma limitação ferramental, sendo bastante
complicado aprofundar a ranhura (destacada na figura \ref{fig:ranhura}) da polia
do trocador manual de forma uniforme, isto é, de forma que o raio permanecesse
com o mesmo valor sempre.
\begin{figure}[!h]
\begin{center}
  \includegraphics[width=4.5in]{ranhura}
\end{center}
  \caption{Ranhura da polia do cabo de acionamento}
  \label{fig:ranhura}
\end{figure}

Manter o raio da polia uniforme é imprescindível pois o passo entre as coroas
no cassete são constantes, ou seja, caso variável o engate das marchas fica
comprometido. Sem uma forma de garantir a uniformidade, essa alternativa foi
deixada de lado no curto prazo.

Na consideração da segunda alternativa, foi questionado o porquê de um
\textit{derailleur} possuir uma mola de retorno de constante elástica
relativamente grande -- infelizmente não havia forma de medir seu valor, e não
há especificação disponível pelo fabricante, visto que constitui um dos
segredos do projeto. O valor é tal que possa garantir do \textit{derailleur} a
posição mínima, não importando as condições e configurações. Isto é, o
\textit{derailleur} é uma peça mecânica que fica completamente exposta aos
elementos, sendo que seu funcionamento tem que ser garantido o mesmo estando
este completamente limpo e lubrificado, ou cheio de barro. Há também o atrito no
cabeamento, que está sujeito a mesma variação de resistência do
\textit{derailleur}.

A segunda consideração é que, decidindo por uma intervenção na mola de retorno,
a construção da gaiola do \textit{derailleur} é projetada para não ser
desmontável (detalhe da figura \ref{fig:derra}), com rebites e pinos
fixados por interferência. Ou seja, não há uma maneira simples de reconfigurar
este elemento, e caso houvesse, arrisca-se perder a robustez no seu
funcionamento.

Esta deixa de ser uma opção, e nesse sentido apenas uma completa
reformulação do \textit{derailleur} -- talvez abandonando completamente o
acionamento por cabo e a mola de retorno, acoplando um servo motor na sua
construção\footnote{A fabricante japonesa Shimano possui uma série de
\textit{derailleurs} eletrônicos de controle manual chamada Di2} -- pode vir a
funcionar.

\begin{figure}[h!]
\begin{center}
 \includegraphics[width=4.5in]{derra}
\end{center}
  \caption{Detalhe da construção da gaiola do \textit{derailleur}.}
  \label{fig:derra}
\end{figure}

A terceira opção é, entre todas, aquela que mais se aproxima da substituição de
um agente humano no controle, ou seja, um atuador capaz de produzir o torque
necessário para a troca de marchas. O que significa ir ao mercado e pesquisar
as opções disponíveis de servos de alto torque.

\subsubsection{Resolução de problemas}
Para prosseguir com os trabalhos, a tentativa foi pegar um velho
\textit{derailleur} e afrouxar a sua mola de retorno. Porém o acesso a mola não
é direto, e a mola foi completamente retirada. Ainda assim, alguma força de
retorno é necessária, então um elástico foi adaptado ao mecanismo, como
apresentado na figura \ref{fig:adapt1}.

\begin{figure}[h!]
\begin{center}
 \includegraphics[width=4.5in]{adapt1}
\end{center}
  \caption{Tentativa de adaptação de \textit{derailleur}.}
  \label{fig:adapt1}
\end{figure}

No canto esquerdo da imagem observa-se o que restou da tentativa de
afrouxamento da mola de retorno.

O sistema foi iniciado e novamente o servo não foi suficiente para ...
%TODO: keep on here.

\subsubsection{Detalhes da Implementação}
\label{sec:code_detail}
%TODO detalhes da implementação
O primeiro detalhe em destaque é a aquisição dos tempos de revolução da roda e
da cadência (rotação do pedivela). Houve a necessidade de usar rotinas de
interrupção para tratar os eventos gerados pelos \textit{reed's} e poder contar
o tempo entre cada evento. As interrupções, como dizem o nome, interrompem o
fluxo de execução do programa, chamando a rotina de interrupção para processar
o evento de forna aninhada. O requisito de qualquer rotina de interrupção é que
seja breve para que o fluxo geral do sistema não fique prejudicado.

Dois pinos de entrada digital 2 e 3 do Arduino foram associados às
rotinas para contar o tempo da cadência e da roda, respectivamente. A
associação é feita na borda de descida do sinal, tornando o sistema mais
robusto aos efeitos do \textit{bouncing} nos \textit{reed switches}. O
trecho de código a seguir, parte do arquivo $principal.pde$, é referente ao
tempo da cadência apenas, pois não há necessidade de reproduzir o código do
tempo da roda, visto que apenas alguns nomes são substituídos.
\begin{lstlisting}
// Pin config for interrupt routine
attachInterrupt ( 0, cadence_monitor, FALLING );
...
/*
 * cadence time interrupt
 * routine
 */
void cadence_monitor() {
  // first time log
  if ( c == false ) {
    ctimeLog[0] = millis();
    c=true;
  }
  else {
    ctimeLog[1] = millis();
    ctime = ctimeLog[1] - ctimeLog[0];
    ctimeLog[0] = ctimeLog[1];
  }
}
...
/*
 * timers reset routine
 */
void reset_timers() {
  unsigned long now = millis();
  if (now - wtimeLog[0] > RESET_TIMEOUT) {
    wtime = 0;
  }
  if (now - ctimeLog[0] > RESET_TIMEOUT) {
    ctime = 0;
  }
}
\end{lstlisting}
Na linha 2, a configuração necessária para associar a interrupção à rotina
$cadence_monitor$ na borda de descida. No linha 8, a rotina de interrupção
propriamente dita, guarda na primeira execução um valor de tempo (função
$millis()$ que retorna a contagem de tempo em milissegundos desde que o
microcontrolador foi iniciado) inicial. Da segunda chamada em diante, a
variável $ctime$ recebe o tempo da cadência através da subtração do registro
atual do tempo de execução com o registro anterior anterior, armazenado no
vetor $ctimeLog$.

Na linha 24, a função $reset\_timers$ é usada para zerar os contadores de tempo
de cadência e roda para que, caso a interrupção não seja disparada por um tempo
muito grande, o valor destes contadores não retornem valores absurdos.

O segundo detalhe fica em conta do fluxo de execução do algoritmo apresentado
na seção \ref{sec:software}. A implementação principal foi feita em um
\textit{looping} infinito (função $loop()$ na primeira linha). No trecho do
código do arquivo $principal.pde$:

\begin{lstlisting}
void loop() {
  // check if coasting
  if (( ctime < CADENCE_MIN ) || ( ctime != 0)) {
    // if not act over transmission
    //gear=trocador.get_gear ( ctime, wtime );
    ratio=float(ctime)/wtime;
    for (int i=0;i<6;i++) {
        if (closeto(ratio,validratios[i],TOLERANCE)) {
            gear = i+1;
        }
    }
    trocador.set_gear ( motor, gear, ctime, wtime, K );
  }
...
}
/*
 * Return true if param is within
 * tolerance [%] of reference:
 */
boolean closeto(float param, float reference, float tolerance) {
    return ( (param >= (reference*(100-tolerance)/100) ) &&
      (param <= (reference*(100+tolerance)/100) ) );
}
\end{lstlisting}
A execução, na linha 3, testa se o ciclista está "deslizando"
(\textit{coasting}), ou seja, em movimento inercial sem movimentar os pedais.
Caso não esteja, a execução segue apenas verificando os botões de configuração,
lendo informação de velocidade, e atualizando o display. Caso o ciclista esteja
pedalando, na linha 6 calcula a relação entre o tempo da cadência e tempo da
roda, e atualiza o valor da marcha engatada, usando a função $closeto$,
linha 20, que retorna verdadeiro caso o valor da relação esteja contido no
vetor das relações esperadas, com uma margem de tolerância. A seguir, na linha
12, faz chamada a função da biblioteca que se encarrega de testar e trocar a
marcha, quando necessário.
A função para determinação da marcha engatada é originalmente parte do código da
biblioteca, porém algum problema não diagnosticado impedia que a chamada a esta
função retornasse o valor correto.

O terceiro e mais importante detalhe da implementação é método de escolha e
mudança de marcha, da classe \textit{Derailleur}. Este método recebe o objeto
representando o servo motor, a marcha atual, os tempos de roda e cadência (i.e.
as velocidades) e a constante K de ajuste. O trecho a seguir mostra a
implementação.
\begin{lstlisting}
/*
 * Core method of the library. responsable
 * for choosing and setting a new gear
 * position
 */
void Derailleur::set_gear ( Servo motor, int gear, long int c_t, long int w_t,
float K ) {
    if ( ( c_t < CADENCE_MIN*K ) && ( gear != GEAR_MIN ) ) {
        motor.write (int( STEP* ( gear + 1 ) *UP_OFFSET ));
        //while ( gear == this->get_gear ( c_t, w_t ) ) {
        //Serial.print("Subindo marcha...");
        delay(400);
        //}
        motor.write ( STEP* ( gear + 1 ) );
    } else if ( ( c_t > CADENCE_MAX*K ) && ( gear != GEAR_MAX ) ) {
        motor.write (int( STEP* ( gear - 1 ) *DOWN_OFFSET ));
        //while ( gear == this->get_gear ( c_t, w_t ) ) {
          //Serial.print("Descendo marcha...");
        delay(400);
        //}
        motor.write ( STEP* ( gear - 1 ) );
    }
}
\end{lstlisting}
O código da linha 8 testa a condição "Velocidade abaixo do limite inferior
para a relação" levando em consideração o fator K de ajuste, e a condição
"Coroa anterior disponível", como apresentado no fluxograma da figura
\ref{fig:fluxograma1}. Da mesma forma, o código da linha 15 testa a condição
"Velocidade além do limite superior para a relação" levando em conta o fator K
de ajuste, e a condição "Próxima coroa disponível", também apresentado no
fluxograma do algoritmo.

\subsubsection{Resultados}
\label{sec:resultados}
Apesar de não ter sido possível testar o sistema em sua plenitude, a observação
da movimentação do servo motor, livre do cabeamento, e a visualização de dados
do programa na interface serial sugerem que, dada uma solução para as questões
mecânicas do atuador, a proposta do projeto pode ser alcançada.


\pagebreak
%%%
%
\section{Conclusões}
\label{sec:conclusoes}
%TODO concluir Redundância da introdução Dificuldades

Em tempos de aumento da preocupação com questões ambientais, emissão de
poluentes, humanização das cidades, -- descaracterizadas e transformadas para
servir aos veículos automotores -- a bicicleta aparece como um agente
transformador. Seu apelo à saúde e ecológico, baixo custo e facilidade de uso
já a promovem ao veículo urbano do futuro, sendo que as diversas iniciativas de
incentivo ao uso de bicicletas comunitárias e/ou públicas ao redor do mundo, e
inclusive em nossa Universidade, estão aí para comprovar esta teoria. 

Muitas extensões podem ser feitas neste projeto, visto que como uma prova de
conceito, é uma implementação muito simplificada. A primeira adição proposta
é adicionar um segundo atuador para ser capaz de manipular o
\textit{derailleur} das coroas dianteiras, podendo utilizar toda a extensão das
marchas disponíveis. Uma forma de incluir esse atuador no algoritmo seria
realizar as trocas nas coroas dianteiras quando a mudança de velocidade for
mais brusca. Isso porque a relação entre as coroas dianteiras é tipicamente
maior quando comparadas a relação entre as coroas do cassete.

Uma segunda sugestão é um sistema de gerenciamento de energia, com baterias e
dínamos de roda, que seriam capazes de manter o sistema rodando apenas com a
própria geração de energia.

A terceira sugestão é a possibilidade de configuração de parâmetros em
\textit{runtime}, além de apenas a constante de ajuste K.

Como quarta, a adição de módulos de memória persistente para
que configurações não sejam perdidas a cada desligamento do sistema.

Finalmente, a quinta e última sugestão é a integração de um acelerômetro
eletrônico, de onde é possível ler a informação de inclinação do terreno. Como
em um automóvel, por vezes é interessante adiar a troca de marcha em subidas (a
"esticada") e postergar na descida.

Por fim e ao cabo, apesar da conclusão sem sucesso, a oportunidade de aplicar a
parte mais interessante de todo o conhecimento acumulado na graduação e bater
de frente em dificuldades da engenharia real foi bastante satisfatória.
Ressalto que o trabalho de graduação está finalizado, e que não pode se dizer o
mesmo para o projeto do câmbio automático para bicicletas.

\begin{figure}[h!]
\begin{center}
 \includegraphics[width=4in]{evo}
\end{center}
\end{figure}


\pagebreak
%%%
%
\section{Anexos}
\label{sec:anexos}

%%%
%

%%%
%
\subsection{Custos do Projeto}
\label{custos}
Os custos dos materiais utilizados foram relativamente baixos. O
reaproveitamento de componentes previamente adquiridos, e principalmente, o
baixo custo dos componentes envolvidos possibilitaram minimizar esta soma. A
Tabela \ref{tab:custos} a seguir computa os componentes e ferramentas.
{
\newcommand{\mc}[3]{\multicolumn{#1}{#2}{#3}}
\begin{table}[ht]
\begin{center}
\caption{Custos do projeto}
\label{tab:custos}
\begin{tabular}{lc}
\mc{1}{c}{\textbf{Material}} & \textbf{Preço (R\$)}\\\hline
Movimento central & R\$ 12,00\\
Display LCD 16x2 & R\$ 20,00\\
Arduino Duemilenove & R\$ 40,00\\
Servo Futaba s3004 & R\$ 12,00\\
Ferro de solda 100W & R\$ 18,00\\
\textit{Reed switch} (5x) & R\$ 3,45\\
Resistores 10k (6x) & R\$ 0,78\\\hline
\textbf{Total} & \textbf{R\$ 106,23}\\\hline
\end{tabular}
\end{center}
\end{table}
}



%%%
%
\subsection{Código Fonte}
\label{codigo}

\subsubsection{API da Biblioteca \textit{BikeTransmission}}
\label{code:api}
\textit{BikeTransmission.h}:
\lstinputlisting{../BikeTransmission/BikeTransmission.h}

\subsubsection{Implementação da Biblioteca \textit{BikeTransmission}}
\label{code:impl}
\textit{BikeTransmission.cpp}:
\lstinputlisting{../BikeTransmission/BikeTransmission.cpp}

\subsubsection{Programa principal}
\label{code:main}
\textit{principal.pde}
\lstinputlisting{../principal/principal.pde}

%%
%
\lstset{frame=single,
    language=Python,
    basicstyle=\ttfamily\small,
    otherkeywords={=, +, [, ], (, ), \{, \}, :},
    keywordstyle=\color{blue},
    stringstyle=\color{red},
    showstringspaces=false,
    emph={class, pass, in, for, while, if, is, elif, else, not, and, or,
    def, print, exec, break, continue, return},
    emphstyle=\color{black}\bfseries,
    emph={[2]True, False, None, self},
    emphstyle=[2]\color{key},
    emph={[3]from, import, as},
    emphstyle=[3]\color{blue},
    upquote=true,
    morecomment=[s]{"""}{"""},
    commentstyle=\color[RGB]{105,105,105}\slshape,
    basicstyle=\tiny,
}
\subsubsection{Cálculo de Relação entre marchas}
\label{code:ratios}
\textit{ratios.py}
\lstinputlisting{../ratios.py}

\subsubsection{Cálculo de Filtro RC}
\label{code:filter}
\textit{capacitance\_n\_resistance.py}
\lstinputlisting{../capacitance_n_resistance_calc.py}




\pagebreak
%%%
%
% bibliografia precisa ser explicitamente adicionada ao sumário:
\addcontentsline{toc}{section}{Referências}
\bibliographystyle{plain}
\bibliography{report}

\end{document}
